---
version: 2.1

parameters:
  promote:
    type: boolean
    default: false
  version:
    type: string
    default: ""
  is_prod:
    type: boolean
    default: false

docker_auth: &docker_auth
  username: $DOCKERHUB_USERNAME
  password: $DOCKERHUB_PASSWORD

defaults: &defaults
  docker:
    - image: greenpeaceinternational/p4-builder:latest
      auth:
        <<: *docker_auth
  working_directory: /home/circleci/

orbs:
  slack: circleci/slack@3.4.2

job_environments:
  common_environment: &common_environment
    TYPE: "Build"
    APP_HOSTNAME: www-dev.greenpeace.org
    APP_HOSTPATH: base
    CONTAINER_PREFIX: planet4-base
    GOOGLE_PROJECT_ID: planet-4-151612
    HELM_NAMESPACE: develop
    WP_TITLE: Greenpeace Base Development
  develop_environment: &develop_environment
    APP_ENVIRONMENT: development
  production_environment: &production_environment
    APP_ENVIRONMENT: production

job_definitions:
  build_steps: &build_steps
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Configure
          command: |
            activate-gcloud-account.sh
            mkdir -p /tmp/workspace/var
            mkdir -p /tmp/workspace/src
            echo "${CIRCLE_BUILD_NUM}" > /tmp/workspace/var/circle-build-num
      - run:
          name: Build containers
          working_directory: /home/circleci
          command: |
            GIT_REF=${CIRCLE_BRANCH} make
      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - var
            - src

  test_steps: &test_steps
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Clone planet4-docker-compose
          command: |
            git clone https://github.com/greenpeace/planet4-docker-compose
      - run:
          name: Start docker-compose
          command: |
            export BUILD_TAG="build-$(cat /tmp/workspace/var/circle-build-num)"
            export APP_IMAGE=gcr.io/planet-4-151612/planet4-base-app:${BUILD_TAG}
            export OPENRESTY_IMAGE=gcr.io/planet-4-151612/planet4-base-openresty:${BUILD_TAG}
            make -C planet4-docker-compose hosts ci
      - run:
          name: Install codeception
          command: |
            make -C planet4-docker-compose install-codeception test-env-info
      - run:
          name: Run tests
          command: |
            make -C planet4-docker-compose test-codeception
      - run:
          name: Extract test artifacts
          when: always
          command: |
            export BUILD_TAG="build-$(cat /tmp/workspace/var/circle-build-num)"
            export APP_IMAGE=gcr.io/planet-4-151612/planet4-base-app:${BUILD_TAG}
            export OPENRESTY_IMAGE=gcr.io/planet-4-151612/planet4-base-openresty:${BUILD_TAG}
            make -C planet4-docker-compose ci-extract-artifacts
      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - var
      - store_test_results:
          path: planet4-docker-compose/artifacts
      - store_artifacts:
          path: planet4-docker-compose/artifacts

  release_steps: &release_steps
    docker:
      - image: greenpeaceinternational/circleci-base:latest
        auth:
          <<: *docker_auth
    working_directory: /tmp/workspace
    parameters:
      pipeline:
        default: "main"
        type: string
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Trigger sites release
          command: |
              declare -a sites
              mapfile -t sites < sites.txt
              for i in "${sites[@]}"
              do
                trigger-build.sh git@github.com:greenpeace/planet4-$i.git << parameters.pipeline >>
              done
      - when:
          condition:
            equal: ["main", << parameters.pipeline >>]
          steps:
            - run:
                name: Trigger dev sites release
                command: |
                    declare -a dev_sites
                    mapfile -t dev_sites < dev_sites.txt
                    for i in "${dev_sites[@]}"
                    do
                      trigger-build.sh git@github.com:greenpeace/planet4-$i.git << parameters.pipeline >>
                    done

jobs:
  lint:
    docker:
      - image: greenpeaceinternational/circleci-base:latest
        auth:
          <<: *docker_auth
    steps:
      - checkout
      - run: make lint

  build:
    <<: *defaults
    environment:
      <<: *common_environment
      <<: *develop_environment
    <<: *build_steps

  build-production:
    <<: *defaults
    environment:
      <<: *common_environment
      <<: *production_environment
    <<: *build_steps

  test:
    <<: *defaults
    <<: *test_steps

  test-production:
    <<: *defaults
    <<: *test_steps

  release-dev-sites:
    environment:
      TYPE: "Trigger"
      <<: *develop_environment
    <<: *release_steps

  release-prod-sites:
    environment:
      TYPE: "Trigger"
      <<: *production_environment
    <<: *release_steps

  changelog:
    docker:
      - image: greenpeaceinternational/circleci-base:latest
        auth:
          <<: *docker_auth
    working_directory: /tmp/workspace/
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Configure git
          command: |
            mkdir -p ~/.ssh
            echo 'github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==
            ' >> ~/.ssh/known_hosts
      - run:
          name: Update Changelog and notify
          command: |
            version=$(git describe --abbrev=0 --tags)
            changelog.sh "$version"
      - slack/notify:
          channel: C014UMRC4AJ
          mentions: here
          color: '#78c043'
          message: "A new release is currently being deployed.\nCheck the <https://support.greenpeace.org/planet4/tech/changelog|Changelog> for the full list of changes"
          include_job_number_field: false
          include_project_field: false
          include_visit_job_action: false

  rollback-sites:
    docker:
      - image: greenpeaceinternational/circleci-base:latest
        auth:
          <<: *docker_auth
    working_directory: /tmp/workspace
    steps:
      - checkout
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Trigger sites rollback
          command: |
              declare -a sites
              mapfile -t sites < sites.txt
              for i in "${sites[@]}"
              do
                ./bin/rollback.sh planet4-$i ${CIRCLE_TOKEN}
              done

  tag:
    <<: *defaults
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true
      - run:
          name: Create new tag
          command: |
            commit_message=$(git log -1 HEAD --pretty=format:%s)
            ./bin/tag.py "${commit_message}"

  trigger-production:
    docker:
      - image: greenpeaceinternational/circleci-base:latest
        auth:
          <<: *docker_auth
    steps:
      - checkout
      - run:
          name: Check if this is a release commit
          command: |
            commit_message=$(git log -1 HEAD --pretty=format:%s)
            if [[ "$commit_message" != *"[release]"* ]]; then
              echo "Not a release commit"
              circleci-agent step halt
            fi
      - run:
          name: Trigger production pipeline
          command: ./bin/production.sh

  promote:
    docker:
      - image: greenpeaceinternational/circleci-base:latest
        auth:
          <<: *docker_auth
    working_directory: /tmp/workspace/
    parameters:
      version:
        default: ""
        type: string
    steps:
      - checkout
      - run:
          name: Promote version
          command: ./bin/promote.py << parameters.version >>

workflow_definitions:
  main: &main
    context: org-global
    filters:
      branches:
        only: main

  tag: &tag
    context: org-global
    filters:
      branches:
        ignore: /.*/
      tags:
        only: /^v.*/

workflows:
  develop:
    unless:
      or:
        - << pipeline.parameters.promote >>
        - << pipeline.parameters.is_prod >>
    jobs:
      - build:
          context: org-global
      - test:
          context: org-global
          requires:
            - build
      - hold-dev-sites:
          <<: *main
          type: approval
          requires:
            - test
      - release-dev-sites:
          <<: *main
          pipeline: main
          requires:
            - hold-dev-sites
      - trigger-production:
          <<: *main

  production:
    when: << pipeline.parameters.is_prod >>
    jobs:
      - build-production:
          <<: *main
      - test-production:
          <<: *main
          requires:
            - build-production
      - hold-tag:
          <<: *main
          type: approval
          requires:
            - test-production
      - tag:
          <<: *main
          requires:
            - hold-tag

  cron-develop:
    triggers:
      - schedule:
          cron: "0 12 * * 0"
          filters:
            branches:
              only:
                - main
    jobs:
      - build:
          context: org-global
      - test:
          context: org-global
          requires:
            - build
      - release-dev-sites:
          context: org-global
          pipeline: main
          requires:
            - test

  promote:
    when: << pipeline.parameters.promote >>
    jobs:
      - hold-promote:
          <<: *main
          type: approval
      - promote:
          <<: *main
          version: << pipeline.parameters.version >>
          requires:
            - hold-promote

  release:
    jobs:
      - hold-release:
          <<: *tag
          type: approval
      - release-prod-sites:
          <<: *tag
          pipeline: tag
          requires:
            - hold-release
      - hold-changelog:
          <<: *tag
          type: approval
          requires:
            - release-prod-sites
      - changelog:
          <<: *tag
          requires:
            - hold-changelog

  rollback:
    jobs:
      - hold-rollback:
          type: approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /rollback-v*/
      - rollback-sites:
          context: org-global
          requires:
            - hold-rollback
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /rollback-v*/
